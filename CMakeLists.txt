# è®¾ç½®CMakeæœ€ä½ç‰ˆæœ¬å’Œé¡¹ç›®åç§°
cmake_minimum_required(VERSION 3.14)
project(myQATModel CXX C)

# --- æŸ¥æ‰¾å¹¶è®¾ç½®å¿…è¦çš„åŒ… ---
find_package(Threads REQUIRED)
find_package(OpenMP REQUIRED)

# --- è®¾ç½®C++æ ‡å‡† ---
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

#-----------------------------------------------------------------------------
# 1. ä¸ºæ‰€æœ‰ç›®æ ‡å…±äº«çš„é€šç”¨ä»£ç åˆ›å»ºä¸€ä¸ªé™æ€åº“ âš™ï¸
#-----------------------------------------------------------------------------
add_library(qat_core STATIC
    src/types.cpp
    src/utils.cpp
    src/kernels.cpp
    src/profiler.cpp
)

# ä¸ºæ ¸å¿ƒåº“è®¾ç½®PUBLICå±æ€§ï¼Œè¿™æ ·é“¾æ¥åˆ°å®ƒçš„ç›®æ ‡ä¼šè‡ªåŠ¨ç»§æ‰¿è¿™äº›è®¾ç½®
target_include_directories(qat_core PUBLIC 
    include
)

target_compile_definitions(qat_core PUBLIC
    GGML_BITNET_X86_TL2
    GGML_BITNET_X86_AVX2
    #GGML_BITNET_X86_AVX512
)

target_link_libraries(qat_core PUBLIC
    Threads::Threads
    OpenMP::OpenMP_CXX
)

# å°†ç¼–è¯‘å™¨ç‰¹å®šä¼˜åŒ–é€‰é¡¹ä¹Ÿåº”ç”¨åˆ°æ ¸å¿ƒåº“
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    target_compile_options(qat_core PUBLIC -mavx2 -Ofast)
elseif(CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
    target_compile_options(qat_core PUBLIC /arch:AVX2)
endif()


#-----------------------------------------------------------------------------
# 2. æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶é“¾æ¥åˆ°æ ¸å¿ƒåº“ ğŸ”—
#-----------------------------------------------------------------------------

# --- æ„å»ºä¸»åº”ç”¨ç¨‹åº ---
add_executable(myQATModel
    src/main.cpp
)
target_link_libraries(myQATModel PRIVATE qat_core)

# --- æ„å»ºé€Ÿåº¦æµ‹è¯•ç¨‹åº ---
add_executable(speed_test
    src/speed_test.cpp
)
target_link_libraries(speed_test PRIVATE qat_core)

# --- æ„å»ºå›¾åƒç”Ÿæˆç¨‹åº ---
add_executable(generate_image 
    src/generate_image.cpp
    src/qat_unet_model.cpp  # è¿™ä¸ªæºæ–‡ä»¶æ˜¯æ­¤ç›®æ ‡ç‰¹æœ‰çš„
)
target_link_libraries(generate_image PRIVATE qat_core)

add_executable(test_attention 
    src/test_attention.cpp
)
target_link_libraries(test_attention PRIVATE qat_core)
